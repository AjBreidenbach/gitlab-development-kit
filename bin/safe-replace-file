#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

source_file=$1
dest_file=$2
gitlab_development_root=$3

dest_content=$(sed -e "s|/home/git|${gitlab_development_root}|g" "${source_file}")

if [[ -f "$dest_file" ]]; then
  # If the target file exists and differs from what we want to see in it...
  if ! cmp --silent "${dest_file}" <( echo "${dest_content}" ); then
    echo "-------------------------------------------------------------------------------------------------------------"
    echo "Warning: Your \`${dest_file}\` is outdated. To automatically update, \`rm ${dest_file}\`"
    echo "and re-run \`gdk update\`"
    echo "Alternatively, update your copy with the changes below. To silence this warning, at your own peril:"
    echo "\`touch ${dest_file}\`"
    echo "-------------------------------------------------------------------------------------------------------------"
    echo "Diff to follow after an attention-grabbing 5-second delay..."
    sleep 5

    diff -c gitlab/config/puma.rb  <( echo "${dest_content}" ) || true
  fi
else
	echo "${dest_content}" > "${dest_file}"
fi
